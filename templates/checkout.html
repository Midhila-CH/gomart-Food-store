{% include 'banner.html' %}
<div class="container-head">
    <h1 style="margin-left:45%">Check Out Page</h1>
    <ul class="listing">
        <a href="{% url 'index' %}"><li>Home >></li></a>
        <a href="#"><li>Page >></li></a>
        <a href="#"><li>Check Out</li></a>
    </ul>
</div>

<div class="checkout-container">
    <h2>Shipment Address</h2>
    <form id="save-address-form" method="POST" action="{% url 'save_address' %}">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6 mb-3">
                <label>First Name</label>
                <input type="text" class="form-control" name="first_name" required>
            </div>
            <div class="col-md-6 mb-3">
                <label>Last Name</label>
                <input type="text" class="form-control" name="last_name" required>
            </div>
            <div class="col-md-12 mb-3">
                <label>Street Address</label>
                <input type="text" class="form-control" name="address" required>
            </div>
            <div class="col-md-6 mb-3">
                <label>Mobile</label>
                <input type="tel" class="form-control" name="mobile" pattern="[0-9]{10}" required/>
            </div>
            <div class="col-md-6 mb-3">
                <label>Email</label>
                <input type="email" class="form-control" name="email" required>
            </div>
            <div class="col-md-6 mb-3">
                <label>State</label>
                <input type="text" class="form-control" name="state">
            </div>
            <div class="col-md-6 mb-3">
                <label>Pincode</label>
                <input type="text" class="form-control" name="pincode">
            </div>
        </div>
        <button type="submit" class="btn btn-warning w-100">Save this Address</button>
    </form>

    <hr>

    <div class="order-summary">
        <h4>Order Summary</h4>

        {% if order %}
        <p><strong>Order ID:</strong> {{ order.id }}</p>
        {% endif %}
        <p>Items Total: ₹{{ subtotal }}</p>
        <p>Shipping & Handling: ₹{{ shipping }}</p>
        <h5>Total: ₹{{ total }}</h5>

        <!-- Order buttons initially hidden -->
        <div id="order-buttons" style="display: none;">
            <!-- COD Form -->
            <form id="cod-form" method="POST" action="{% url 'cod_checkout' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success w-100 mt-2">Place Order Cash On Delivery</button>
            </form>

            <!-- Razorpay -->
            <button id="rzp-button1" class="btn btn-primary w-100 mt-2">Place Order via Online</button>
        </div>

        <p class="text-danger mt-3"><small>Do not refresh this page until payment is complete.</small></p>
        <p class="text-danger">Complete Shipping Address For Payment</p>
    </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    // Save Address AJAX
    $('#save-address-form').on('submit', function (e) {
        e.preventDefault();
        $.ajax({
            url: "{% url 'save_address' %}",
            method: 'POST',
            data: $(this).serialize(),
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            success: function (response) {
                console.log("✅ Address saved");
                $('#order-buttons').fadeIn();  // Show COD & Razorpay buttons
                RazorpayOptions.order_id = response.razorpay_order_id;
            },
            error: function () {
                alert("Failed to save address.");
            }
        });
    });

    // Razorpay setup
    var RazorpayOptions = {
        "key": "{{ razorpay_merchant_key }}",
        "amount": "{{ razorpay_amount }}",
        "currency": "INR",
        "name": "Your Store",
        "description": "Order Payment",
        "order_id": "", // Filled after saving address
        "handler": function (response) {
            $.ajax({
                url: "{% url 'online_checkout' %}",
                method: "POST",
                data: {
                    payment_id: response.razorpay_payment_id,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function () {
                    window.location.href = "{% url 'payment_success' %}";
                },
                error: function () {
                    alert("Payment failed.");
                }
            });
        },
        "theme": {
            "color": "#3399cc"
        }
    };

    $('#rzp-button1').click(function (e) {
        e.preventDefault();
        const rzp = new Razorpay(RazorpayOptions);
        rzp.open();
    });
</script>
